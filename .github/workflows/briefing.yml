name: ðŸ¤– AI Briefing

on:
  # ProgramaciÃ³n (Cron usa hora UTC)
  # Ejemplo para EspaÃ±a (UTC+1 en invierno, UTC+2 en verano):
  # Si quieres las 06:00 AM hora EspaÃ±a:
  # Invierno: Poner '0 5 ...' (5 AM UTC)
  # Verano: Poner '0 4 ...' (4 AM UTC)
  # AquÃ­ pongo 05:00 UTC, 13:00 UTC, 21:00 UTC (aprox 6am, 2pm, 10pm hora local)
  schedule:
    - cron: '0 5,13,21 * * *'
  
  # Permite ejecutarlo manualmente desde la pestaÃ±a "Actions" para probar
  workflow_dispatch:

jobs:
  run-briefing:
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar el cÃ³digo
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. Instalar Python
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. Instalar Tesseract OCR con EspaÃ±ol (CRÃTICO)
      - name: ðŸ‘ï¸ Install Tesseract OCR (System)
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-spa libtesseract-dev

      # 4. Instalar librerÃ­as de Python
      - name: ðŸ“¦ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5. Reconstruir archivos secretos desde GitHub Secrets
      - name: ðŸ”“ Recreate Secret Files
        env:
          ENV_FILE_CONTENT: ${{ secrets.ENV_FILE }}
          CREDENTIALS_B64: ${{ secrets.CREDENTIALS_JSON_B64 }}
          TOKEN_B64: ${{ secrets.TOKEN_JSON_B64 }}
        run: |
          # Crear .env
          echo "$ENV_FILE_CONTENT" > .env
          
          # Decodificar y crear credentials.json
          echo "$CREDENTIALS_B64" | base64 -d > credentials.json
          
          # Decodificar y crear token.json
          echo "$TOKEN_B64" | base64 -d > token.json
          
          echo "âœ… Archivos de configuraciÃ³n restaurados."

      # 6. Ejecutar el script
      - name: ðŸš€ Run AI Assistant
        env:
          # Inyectamos variables crÃ­ticas por si python-dotenv falla o para sobreescribir
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python main.py